<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
</head>    
<script src="./vendors/jquery-2.1.0.min.js"></script>
<script src="./vendors/underscore-min.js"></script>
<script src="./vendors/gh3.js"></script>    

<script type="text/javascript">
var user;
var user_repos;
var repos;
$(document).ready(function(){
	$("#login").click(function(){
		var email = $("#email").val();
		var password = $("#password").val();
		// Checking for blank fields.
		if( email =='' || password ==''){
			$('input[type="text"],input[type="password"]').css("border","2px solid red");
			$('input[type="text"],input[type="password"]').css("box-shadow","0 0 3px red");
			alert("Please fill all fields...!!!!!!");
		}else {
			user = new Gh3.User(email);
			
			user.fetch(function (err, resUser){

				if(err) {
					throw "outch ..."
				}

				
				}
			);
			//get some repositories for user
			user_repos = new Gh3.Repositories(user);
			var pagination = {page: 1, per_page : 10 , direction : "desc"};
			
			user_repos.fetch(
				pagination,
				"next", 
				function (err, res) {
					if(err) {
						throw "outch ..."
					}
					// adds div for selector
					$("#content_row").append("<div id=\"repos\"></div>");
					//adds selector with repositorie
					$("#repos").append("<select id=\"repos_selector\"></select>");
					// fill selector
					res.repositories.forEach(fillOptions)
					$("#repos").append("<input type=\"button\" id=\"fetch_branches\" value=\"Select\"></input>");
					$("#fetch_branches").click(getBranches);
				}
			);
			
			repos = user_repos.getRepositories();
			
			
		}
	});
});

var fillOptions = function(el) {
	$("#repos_selector").append("<option " + 
		//"onselect=\"getBranches(\""+ el +"\");\" " + 
		" value=\""+ el.name +"\">"+ el.name +"</option>");
} 

var getBranches = function () {
	var reponame = $("#repos_selector").val();
	if (reponame != "") {
		var i = 0;
		while (repos[i].name != reponame ) i = i+1;
		
		var thisrepo = repos[i];
		console.log("getBranches for " + reponame);
		thisrepo.fetchBranches(function (err, res) {
			if(err) { throw "outch ..." }

			console.log("Array of branches : ", thisrepo.getBranches());
			thisrepo.eachBranch(getBranchContent);

		}
		)
	}
}

var fileData = [];

var getBranchContent = function (branch) {
	branch.fetchContents(function (err, res) {
            if(err) { throw "outch ..." }

            branch.eachContent(function (content) {
                console.log(content.path, content.type);
				fileData.push(content);
				if (content.type == 'file') {
					content.fetchCommits(getFileCommits);
				} else {
					// traverse the directory
					content.fetchContents(recursiveTraverseDirectory);
				}
			});
        });
}

var fileCommits = [];
var getFileCommits = function(err, file) {
	if (err) {
		alert ("Error fetching file commits");
		throw "Error fetching file commits";
	}
	fileCommits.push(file.getCommits());
	file.eachCommit(function (commit) {
            console.log(commit.author.login, commit.message, commit.date);
    });
	
	
}

var recursiveTraverseDirectory = function (err, res) {
	if(err) { throw "outch ..." }

	console.log(res.getContents());

	res.eachContent(function (cont) {
		console.log(cont.name, cont.type, cont.size);
		if (cont.type == 'dir') cont.fetchContents(recursiveTraverseDirectory);
		else if (cont.type == 'file') {
			fileData.push(cont);
			cont.fetchCommits(getFileCommits);			
		}
	});
}
</script>

<body style="background-color:gray;">
<h1>Project Dashboard</h1>

<div class="container">
<div class="main">
<form class="form" method="post" action="#">

<label>Github user :</label>
<input type="text" name="demail" id="email">
<label>Password :</label>
<input type="password" name="password" id="password">
<input type="button" name="login" id="login" value="Login">
</form>
</div>
</div>
<div id="content_row">
<div>
</body>
</html>