<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
</head>    
<script src="./vendors/jquery-2.1.0.min.js"></script>
<script src="./vendors/underscore-min.js"></script>
<script src="./vendors/gh3.js"></script>    

<script type="text/javascript">
var user;
var user_repos;
var repos;
$(document).ready(function(){
	$("#login").click(function(){
		var email = $("#email").val();
		
		// Checking for blank fields.
		if( email =='' ){
			$('input[type="text"],input[type="password"]').css("border","2px solid red");
			$('input[type="text"],input[type="password"]').css("box-shadow","0 0 3px red");
			alert("Please fill all fields...!!!!!!");
		}else {
			user = new Gh3.User(email);
			
			user.fetch(function (err, resUser){

				if(err) {
					console.log(err);
					throw "outch ..."
				}

				
				}
			);
			//get some repositories for user
			user_repos = new Gh3.Repositories(user);
			var pagination = {page: 1, per_page : 10 , direction : "desc"};
			
			user_repos.fetch(
				pagination,
				"next", 
				function (err, res) {
					if(err) {
						throw "outch ..."
					}
					// adds div for selector
					$("#content_row").append("<div id=\"repos\"></div>");
					//adds selector with repositorie
					$("#repos").append("<select id=\"repos_selector\"></select>");
					// fill selector
					res.repositories.forEach(fillOptions)
					
					// this allows to go through a repository 
					// all files and check the commits
					//$("#repos").append("<input type=\"button\" id=\"fetch_branches\" value=\"Branches\"></input>");
					//$("#fetch_branches").click(getBranches);
					
					$("#repos").append("<input type=\"button\" id=\"fetch_issues\" value=\"Issues\"></input>");
					$("#fetch_issues").click(getIssues);
				}
			);
			
			repos = user_repos.getRepositories();
			
			
		}
	});
});

var fillOptions = function(el) {
	$("#repos_selector").append("<option " + 
		//"onselect=\"getBranches(\""+ el +"\");\" " + 
		" value=\""+ el.name +"\">"+ el.name +"</option>");
} 

var getBranches = function () {
	var reponame = $("#repos_selector").val();
	if (reponame != "") {
		var i = 0;
		while (repos[i].name != reponame ) i = i+1;
		
		var thisrepo = repos[i];
		console.log("getBranches for " + reponame);
		thisrepo.fetchBranches(function (err, res) {
			if(err) { throw "outch ..." }

			console.log("Array of branches : ", thisrepo.getBranches());
			thisrepo.eachBranch(getBranchContent);

		}
		)
	}
}

var fileData = [];

var getBranchContent = function (branch) {
	branch.fetchContents(function (err, res) {
            if(err) { throw "outch ..." }

            branch.eachContent(function (content) {
                console.log(content.path, content.type);
				fileData.push(content);
				if (content.type == 'file') {
					content.fetchCommits(getFileCommits);
				} else {
					// traverse the directory
					content.fetchContents(recursiveTraverseDirectory);
				}
			});
        });
}

var fileCommits = [];
var getFileCommits = function(err, file) {
	if (err) {
		//alert ("Error fetching file commits");
		throw "Error fetching file commits";
	}
	fileCommits.push(file.getCommits());
	file.eachCommit(function (commit) {
            console.log(commit.author.login, commit.message, commit.date);
    });
	
	
}

var recursiveTraverseDirectory = function (err, res) {
	if(err) { throw "outch ..." }

	console.log(res.getContents());

	res.eachContent(function (cont) {
		console.log(cont.name, cont.type, cont.size);
		if (cont.type == 'dir') cont.fetchContents(recursiveTraverseDirectory);
		else if (cont.type == 'file') {
			fileData.push(cont);
			cont.fetchCommits(getFileCommits);			
		}
	});
}


var getIssues = function () {
	var reponame = $("#repos_selector").val();
	var i = repos.findIndex(x => x.name == reponame) ;
	if (i > -1) {
		
		//while (repos[i].name != reponame ) i = i+1;
		
		var thisrepo = repos[i];
		console.log("getIssues for " + reponame);
		thisrepo.fetchIssues(function (err, res) {
			if(err) { throw "outch ..." }
			mIssues = thisrepo.getIssues()
			console.log("Found issues : ", mIssues.length);
			$("#issue_row").append("<table id=\"myTable\"></table>");
			$("#myTable").append("<tr><td>title</td><td>assigned to:</td><td>State</td><td>Created</td><td>Updated</td>");
			//thisrepo.eachIssue(getIssueContent);
			mIssues.forEach(getIssueContent);
		}
		)
	}
}

var mIssues = [];
var issueData = [];
var getIssueContent = function (issue) {
	console.log("Issue: "+issue.title);
	console.log("Created: " + issue.created_at);
	var row = "<tr><td>" + issue.title + "</td>";
	row = row + "<td>" +issue.assignees.reduce((a,x)=> a + x.login + " ","") + 
			"</td>";
	// open? or closed
	if (issue.state == "open"){

		row = row +
			"<td>" + (issue.state) + "</td><td>" + daysFromNow(issue.created_at) + "</td>";
		row = row + 
			"<td>" + daysFromNow(issue.updated_at) + "</td>";
	}

	$("#myTable").append(row+"</tr>");

	/**
	issue.fetchContents(function (err, res) {
            if(err) { throw "outch ..." }

            issue.eachContent(function (content) {
                console.log(content);
				issueData.push(content);
				
			});
	
        });
        **/
}

var daysFromNow = function(iso8601str) {

	var past = Date.parse(iso8601str);
	var now = Date.now();
	var diff = now-past;
	var fDays = diff / (24 * 60 *60 *1000); // elapsed days float
	var nDays = Math.floor(fDays);
	var fHours = (fDays - nDays) * 24 ;
	var nHours = Math.floor(fHours);
	var fMins = (fHours - nHours) * 60;
	var nMins = Math.floor(fMins);
	var fSec = fMins - nMins;
	
	var rte = (nDays > 0? nDays + " days " : "") + 
			  (nHours< 10 ? "0" : "") + nHours + ":" + 
			  (nMins < 10 ? "0" : "" ) +  nMins;
	console.log(rte);
	return rte;

}
</script>

<body style="background-color:gray;">
<h1>Project Dashboard</h1>

<div class="container">
<div class="main">
<form class="form" >

<label>Github user :</label>
<input type="text" name="demail" id="email">

<input type="button" name="login" id="login" value="Login">
</form>
</div>
</div>

<div id="content_row"></div>
<div id="issue_row"></div>

</body>
</html>